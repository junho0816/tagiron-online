<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>íƒ€ê¸°ë¡  ì˜¨ë¼ì¸</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 40px; }
    .hidden { display: none; }
    .question-cards { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin: 20px 0; }
    .card { border: 2px solid #333; padding: 15px 20px; border-radius: 8px; background: #f3f3f3; cursor: pointer; width: 160px; }
    .card.disabled { background: #ccc; cursor: not-allowed; }
    .btn { padding: 10px 20px; margin: 10px; font-size: 16px; cursor: pointer; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
</head>
<body>
  <h1>ğŸ§  íƒ€ê¸°ë¡  2ì¸ ì˜¨ë¼ì¸ ê²Œì„</h1>

  <div id="setup">
    <input id="room" placeholder="ë°© ì½”ë“œ ì…ë ¥" />
    <button class="btn" onclick="joinGame()">ê²Œì„ ì‹œì‘</button>
  </div>

  <div id="game" class="hidden">
    <p><strong>ë‚´ ìˆ«ì:</strong> <span id="myNumbers"></span></p>
    <p>í˜„ì¬ ì°¨ë¡€: <span id="turnDisplay"></span></p>

    <div class="question-cards" id="questionCards"></div>

    <div id="answerSection" class="hidden">
      <p id="receivedQuestion"></p>
      <input id="answerInput" placeholder="ë‹µë³€ ì…ë ¥" />
      <button class="btn" onclick="submitAnswer()">ë‹µë³€ ì œì¶œ</button>
    </div>

    <div>
      <input id="guess" placeholder="ìƒëŒ€ ìˆ«ì ì¶”ì¸¡ (ì˜ˆ: 3,5,7)" />
      <button class="btn" onclick="submitGuess()">ì •ë‹µ ë§ì¶”ê¸°</button>
    </div>

    <div>
      <h3>ì§ˆë¬¸ ê¸°ë¡</h3>
      <ul id="log"></ul>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD6kcJbMZ6hrh2iueE9-BnJWAKcR5Yg5EE",
      authDomain: "tagiron-online.firebaseapp.com",
      databaseURL: "https://tagiron-online-default-rtdb.firebaseio.com",
      projectId: "tagiron-online",
      storageBucket: "tagiron-online.appspot.com",
      messagingSenderId: "725290279395",
      appId: "1:725290279395:web:1a514f1122c562c5a5c0d6"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let roomId = "";
    let player = "";
    let myNumbers = [];
    let isMyTurn = false;

    const questions = [
      "ì§ìˆ˜ëŠ” ëª‡ ê°œ?",
      "ê°€ì¥ í° ìˆ˜ëŠ”?",
      "í•©ì€ ì–¼ë§ˆ?",
      "ì‘ì€ ìˆ˜ëŠ” ëª‡ ê°œì¸ê°€ìš”?",
      "ìˆ«ì ìˆœì„œëŠ” ì˜¤ë¦„ì°¨ìˆœì¸ê°€ìš”?",
      "ê°™ì€ ìˆ«ìê°€ ìˆë‚˜ìš”?"
    ];

    function joinGame() {
      roomId = document.getElementById("room").value;
      if (!roomId) return;
      const roomRef = db.ref("games/" + roomId);

      roomRef.once("value", (snap) => {
        const data = snap.val();
        player = data && data.player1 ? "player2" : "player1";
        myNumbers = Array.from({length: 3}, () => Math.floor(Math.random() * 10));

        roomRef.child(player).set({ numbers: myNumbers });
        roomRef.child("turn").set("player1");
        roomRef.child("questionCards").set(questions);

        document.getElementById("setup").classList.add("hidden");
        document.getElementById("game").classList.remove("hidden");
        document.getElementById("myNumbers").textContent = myNumbers.join(", ");

        roomRef.on("value", (snap) => {
          const game = snap.val();
          if (!game) return;
          isMyTurn = game.turn === player;
          document.getElementById("turnDisplay").textContent = isMyTurn ? "ë‚´ ì°¨ë¡€" : "ìƒëŒ€ ì°¨ë¡€";
          renderQuestionCards(game.questionCards);
          renderLog(game.questionLog);

          if (game.pendingQuestion && game.pendingQuestion.to === player && !game.pendingQuestion.answered) {
            document.getElementById("answerSection").classList.remove("hidden");
            document.getElementById("receivedQuestion").textContent = `ì§ˆë¬¸: ${game.pendingQuestion.question}`;
          } else {
            document.getElementById("answerSection").classList.add("hidden");
          }
        });
      });
    }

    function renderQuestionCards(cards) {
      const container = document.getElementById("questionCards");
      container.innerHTML = "";
      if (!cards) return;

      cards.forEach((q, idx) => {
        const btn = document.createElement("div");
        btn.className = "card" + (!isMyTurn ? " disabled" : "");
        btn.textContent = q;
        if (isMyTurn) {
          btn.onclick = () => selectQuestion(q, idx);
        }
        container.appendChild(btn);
      });
    }

    function selectQuestion(question, index) {
      if (!isMyTurn) return;
      const toPlayer = player === "player1" ? "player2" : "player1";
      const ref = db.ref("games/" + roomId);
      ref.child("pendingQuestion").set({ from: player, to: toPlayer, question, index, answered: false });
    }

    function submitAnswer() {
      const answer = document.getElementById("answerInput").value;
      if (!answer) return;
      const ref = db.ref("games/" + roomId);
      ref.once("value", (snap) => {
        const game = snap.val();
        if (!game || !game.pendingQuestion) return;

        const entry = {
          from: game.pendingQuestion.from,
          question: game.pendingQuestion.question,
          answer
        };

        ref.child("questionLog").push(entry);
        ref.child("pendingQuestion").remove();

        // ì§ˆë¬¸ ì¹´ë“œë¥¼ í•œ ì¥ êµì²´
        const cards = game.questionCards || [];
        cards.splice(game.pendingQuestion.index, 1, questions[Math.floor(Math.random() * questions.length)]);
        ref.child("questionCards").set(cards);

        // í„´ ì „í™˜
        ref.child("turn").set(game.pendingQuestion.to);
      });
    }

    function submitGuess() {
      const guess = document.getElementById("guess").value;
      if (confirm(`ìƒëŒ€ ìˆ«ìê°€ [${guess}] ë§ë‚˜ìš”?`)) {
        alert("ğŸ‰ ê²Œì„ ì¢…ë£Œ! ë‹¹ì‹ ì´ ì´ê²¼ìŠµë‹ˆë‹¤!");
        db.ref("games/" + roomId).remove();
        location.reload();
      }
    }

    function renderLog(log) {
      const ul = document.getElementById("log");
      ul.innerHTML = "";
      if (!log) return;
      Object.values(log).forEach(entry => {
        const li = document.createElement("li");
        li.textContent = `${entry.from} â†’ ${entry.question}: ${entry.answer}`;
        ul.appendChild(li);
      });
    }
  </script>
</body>
</html>
